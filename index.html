<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Quantum JARVIS</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="https://img.icons8.com/nolan/512/iron-man.png">

<style>
/* --- Global Theme --- */
:root { --q-bg: #050007; --q-light: #e3b2ff; --status-color: #b000ff; }
body.idle { --status-color: #b000ff; }
body.listening { --status-color: #00d2ff; }
body.thinking { --status-color: #ffaa00; }
body.speaking { --status-color: #ff2cff; }

html, body { margin: 0; height: 100%; background: var(--q-bg); color: white; font-family: "JetBrains Mono", monospace; overflow: hidden; }

/* Intro Overlay */
#intro-screen { position: fixed; inset: 0; background: #060009; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;}
#begin-btn { margin-top: 24px; padding: 12px 28px; border-radius: 40px; border: 2px solid var(--status-color); background: transparent; color: var(--q-light); box-shadow: 0 0 25px var(--status-color); cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }

/* Reactor */
#core-wrap { position: absolute; top: 12vh; left: 0; right: 0; margin: auto; width: 220px; height: 220px; display: flex; align-items: center; justify-content: center; }
#reactor { width: 100%; height: 100%; border-radius: 50%; border: 4px solid var(--status-color); box-shadow: 0 0 35px var(--status-color), inset 0 0 40px var(--status-color); transition: .1s ease; }

/* HUD Terminal */
#hud { 
    position: absolute; bottom: 0; left: 0; right: 0; height: 45%; padding: 20px; overflow-y: auto; 
    background: linear-gradient(rgba(10,0,20,.9), rgba(5,0,10,.95)); 
    backdrop-filter: blur(10px); border-top: 1px solid rgba(176,0,255,.2);
}
.hud-line { margin: 4px 0; line-height: 1.5; font-size: 13px; white-space: pre-wrap; word-break: break-word; }
.hud-line.user { color: #00d2ff; }
.hud-line.ai { color: var(--q-light); }
.hud-line b { font-weight: bold; margin-right: 8px; }
</style>
</head>

<body class="idle">

<div id="intro-screen">
    <h1 style="text-shadow: 0 0 20px var(--status-color);">QUANTUM JARVIS</h1>
    <p style="font-size: 12px; opacity: 0.7;">System initialization required.</p>
    <button id="begin-btn">Activate Reactor</button>
</div>

<div id="core-wrap">
    <div id="reactor"></div>
</div>

<div id="hud"></div>

<script type="module">
import { GoogleGenAI, Modality } from "https://esm.run/@google/genai";

// Register Service Worker for PWA
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
}

let session=null, inCtx=null, outCtx=null;
const reactor = document.getElementById("reactor");
const hud = document.getElementById("hud");
let nextStart = 0, lastRole = null, currentLineElement = null;
let targetTextBuffer = "";
let displayedTextLength = 0;

function setStatus(s){ document.body.className = s; }

/* --- Smooth Terminal Logic --- */
function hudMsg(text, role) {
    if (!text) return;

    if (role !== lastRole) {
        lastRole = role;
        currentLineElement = document.createElement("div");
        currentLineElement.className = `hud-line ${role}`;
        
        const prefix = document.createElement("b");
        prefix.textContent = role === "user" ? ">_ USER:" : ">_ JARVIS:";
        currentLineElement.appendChild(prefix);
        
        const textSpan = document.createElement("span");
        currentLineElement.appendChild(textSpan);
        
        hud.appendChild(currentLineElement);
        targetTextBuffer = text;
        displayedTextLength = 0;
    } else {
        targetTextBuffer += (targetTextBuffer.endsWith(" ") ? "" : " ") + text;
    }
    hud.scrollTop = hud.scrollHeight;
}

function processTypewriter() {
    if (currentLineElement && displayedTextLength < targetTextBuffer.length) {
        const span = currentLineElement.querySelector("span");
        displayedTextLength++;
        span.textContent = targetTextBuffer.substring(0, displayedTextLength);
        hud.scrollTop = hud.scrollHeight;
    }
    setTimeout(processTypewriter, 15);
}
processTypewriter();

/* --- HD Audio Logic --- */
function encode(f32) {
    const i16 = new Int16Array(f32.length);
    for(let i=0; i<f32.length; i++) {
        const s = Math.max(-1, Math.min(1, f32[i]));
        i16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
    }
    return btoa(String.fromCharCode(...new Uint8Array(i16.buffer)));
}

async function decode(b64, ctx) {
    const bin = atob(b64);
    const i16 = new Int16Array(new Uint8Array([...bin].map(c => c.charCodeAt(0))).buffer);
    const buf = ctx.createBuffer(1, i16.length, 24000);
    const channel = buf.getChannelData(0);
    for(let i=0; i<i16.length; i++) channel[i] = i16[i] / 32768.0;
    return buf;
}

async function startJarvis() {
    let key = localStorage.jarvis_key || prompt("Enter Gemini API Key");
    localStorage.jarvis_key = key;

    inCtx = new AudioContext({sampleRate: 16000});
    outCtx = new AudioContext({sampleRate: 24000});

    await inCtx.audioWorklet.addModule(URL.createObjectURL(new Blob([`
        class VAD extends AudioWorkletProcessor{
            process(inputs){
                const ch = inputs[0][0];
                if(ch){
                    let sum = 0;
                    for(let i=0; i<ch.length; i++) sum += ch[i]*ch[i];
                    this.port.postMessage({pcm:ch, rms:Math.sqrt(sum/ch.length)});
                }
                return true;
            }
        }
        registerProcessor("vad",VAD);
    `], {type: "application/javascript"})));

    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    const node = new AudioWorkletNode(inCtx, "vad");
    inCtx.createMediaStreamSource(stream).connect(node);

    node.port.onmessage = e => {
        const {pcm, rms} = e.data;
        if(rms > 0.01 && document.body.className !== "speaking") setStatus("listening");
        reactor.style.transform = `scale(${1 + rms*5})`;
        reactor.style.boxShadow = `0 0 ${35 + rms*150}px var(--status-color)`;
        if(session) session.sendRealtimeInput({ audio: { data: encode(pcm), mimeType: "audio/pcm;rate=16000" } });
    };

    const ai = new GoogleGenAI({apiKey:key});
    session = await ai.live.connect({
        model: "gemini-2.5-flash-native-audio-preview-12-2025",
        config: {
            responseModalities: [Modality.AUDIO],
            systemInstruction: "You are JARVIS. Respond in a brief terminal format.",
            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Zephyr" } } },
            inputAudioTranscription: {},
            outputAudioTranscription: {}
        },
        callbacks: {
            onopen: () => { setStatus("listening"); hudMsg("Uplink active.", "ai"); },
            onmessage: async msg => {
                if (msg.serverContent?.inputTranscription) {
                    hudMsg(msg.serverContent.inputTranscription.text, "user");
                    setStatus("thinking");
                }
                if (msg.serverContent?.outputTranscription) {
                    hudMsg(msg.serverContent.outputTranscription.text, "ai");
                }
                const audio = msg.serverContent?.modelTurn?.parts?.[0]?.inlineData?.data;
                if (audio) {
                    setStatus("speaking");
                    const buffer = await decode(audio, outCtx);
                    const source = outCtx.createBufferSource();
                    source.buffer = buffer;
                    source.connect(outCtx.destination);
                    nextStart = Math.max(nextStart, outCtx.currentTime);
                    source.start(nextStart);
                    nextStart += buffer.duration;
                    source.onended = () => { if(outCtx.state === 'running') setStatus("listening"); };
                }
            },
            onerror: e => { setStatus("error"); hudMsg("ERR: " + e.message, "ai"); }
        }
    });
}

document.getElementById("begin-btn").onclick = () => {
    document.getElementById("intro-screen").style.display = "none";
    startJarvis();
};
</script>
</body>
</html>